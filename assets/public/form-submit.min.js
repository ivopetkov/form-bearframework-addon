/*
 * Form addon for Bear Framework
 * https://github.com/ivopetkov/form-bearframework-addon
 * Copyright (c) Ivo Petkov
 * Free to use under the MIT license.
 */
var ivoPetkov=ivoPetkov||{};ivoPetkov.bearFrameworkAddons=ivoPetkov.bearFrameworkAddons||{},ivoPetkov.bearFrameworkAddons.formSubmit=ivoPetkov.bearFrameworkAddons.formSubmit||(()=>{var e=null,t=function(e){var t=e.getBoundingClientRect();return[t.width,t.height]},r=function(r,n){var a=document.createElement("a");a.className=e.errorTooltipData.className,a.innerText=n,a.style.left="-1000px",a.style.top="-1000px";var o=function(e){for(;e.parentNode&&void 0!==e.parentNode.tagName;){var t=window.getComputedStyle(e,null);if(null===t)return!1;if("fixed"===t.position)return!0;e=e.parentNode}return!1}(r);o&&(a.style.position="fixed"),document.body.appendChild(a);var i=function(){var n=function(e){var t=e.getBoundingClientRect(),r=Math.round(t.left),n=Math.round(t.top);return[r+=window.pageXOffset,n+=window.pageYOffset]}(r),i=t(r),l=t(a),s=n[0]+(i[0]-l[0])/2;s<5&&(s=5);var u=n[1]-l[1]-2;o&&(s-=window.pageXOffset,u-=window.pageYOffset),a.style.left=s+"px",a.style.top="calc("+u+"px - "+e.errorTooltipData.arrowSize+")"};i();var l=window.setInterval(i,100),s=function(){a.parentNode.removeChild(a),window.removeEventListener("click",s),window.clearInterval(l)};window.addEventListener("click",s)};return{initialize:t=>{null===e&&(e={errorTooltipData:t[0],filesUploadUrl:t[1]})},submit:(t,n,a,o)=>{for(var i={},l=async()=>{await a("submitend"),await o()},s=async()=>{await a("submiterror"),await l()},u=function(){var e={};e.serverData=n.serverData,e.values=JSON.stringify(i),clientPackages.get("serverRequests").then((function(o){o.send("ivopetkov-form",e).then(async e=>{try{var n=JSON.parse(e)}catch(e){n={}}if(void 0!==n.status)if("0"===n.status){if(await s(),void 0!==n.error.element&&n.error.element.length>0){var o=t.querySelector('[name="'+n.error.element+'"]');null!==o&&o.focus()}void 0!==n.error.message&&n.error.message.length>0&&(void 0!==n.error.element&&n.error.element.length>0&&null!==o?r(o,n.error.message):r(t,n.error.message))}else"1"===n.status&&await(async e=>{await a("submitsuccess",{result:e}),await l()})(n.result);else await s()}).catch(async()=>{await s(),r(t,n.errorMessage)})}))},d={},v=!1,f=function(e,t){for(var r in d[e]=1,i[e]={type:"file",value:t},d)if(null===d[r])return;u()},c=t.querySelectorAll("input, select, textarea"),p=c.length,m=0;m<p;m++){var w=c[m];if(w.name.length>0){var g=w.name,y=w.getAttribute("type");null===y&&(y="text"),"file"===y?void 0!==w.files&&w.files.length>0?function(t){d[t]=null;var r=new XMLHttpRequest;r.addEventListener("load",(function(){200===r.status&&r.responseText.indexOf('"filename":')>0?f(t,r.responseText):s()})),r.addEventListener("error",(function(){s()})),r.addEventListener("abort",(function(){s()})),r.addEventListener("timeout",(function(){s()}));for(var n=new FormData,a=0;a<w.files.length;a++)n.append("file"+a,w.files[a]);r.open("POST",e.filesUploadUrl,!0),r.send(n),v=!0}(g):i[g]={type:y,value:""}:"checkbox"===y||"radio"===y?w.checked&&(i[g]={type:y,value:w.value}):i[g]={type:y,value:w.value}}}v||u()}}})();