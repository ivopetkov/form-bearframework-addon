/*
 * Form addon for Bear Framework
 * https://github.com/ivopetkov/form-bearframework-addon
 * Copyright (c) Ivo Petkov
 * Free to use under the MIT license.
 */
var ivoPetkov=ivoPetkov||{};ivoPetkov.bearFrameworkAddons=ivoPetkov.bearFrameworkAddons||{},ivoPetkov.bearFrameworkAddons.formSubmit=ivoPetkov.bearFrameworkAddons.formSubmit||(()=>{var e=null,t=[],n=function(e){var t=e.getBoundingClientRect();return[t.width,t.height]},r=function(e){var t=e.getBoundingClientRect(),n=Math.round(t.left),r=Math.round(t.top);return[n+=window.pageXOffset,r+=window.pageYOffset]},o=function(e,o){for(var a=0;a<1e3;a++){var i=r(e);if(0!==i[0]||0!==i[1])break;e=e.parentNode}if(null!==e&&void 0!==e.tagName){var l=document.createElement("a");l.setAttribute("data-form-component","tooltip"),l.innerText=o,l.style.left="-1000px",l.style.top="-1000px";var u=function(e){for(;e.parentNode&&void 0!==e.parentNode.tagName;){var t=window.getComputedStyle(e,null);if(null===t)return null;if("fixed"===t.position&&null!==e.getAttribute("data-form-tooltip-container"))return e;e=e.parentNode}return null}(e),d=null!==u,s=!d&&function(e){for(;e.parentNode&&void 0!==e.parentNode.tagName;){var t=window.getComputedStyle(e,null);if(null===t)return!1;if("fixed"===t.position)return!0;e=e.parentNode}return!1}(e);s&&(l.style.position="fixed"),d?u.appendChild(l):document.body.appendChild(l);var f=function(){var t=r(e),o=n(e),a=n(l),i=getComputedStyle(l).getPropertyValue("--form-tooltip-arrow-size"),f=t[0]+(o[0]-a[0])/2;f<5&&(f=5);var v=t[1]-a[1]-2;if(d){var c=r(u);f-=c[0]-u.scrollLeft,v-=c[1]-u.scrollTop}else s&&(f-=window.pageXOffset,v-=window.pageYOffset);l.style.left=f+"px",l.style.top="calc("+v+"px - "+i+")"};f(),function(e){var t=e.getBoundingClientRect();return t.bottom<0||t.right<0||t.left>window.innerWidth||t.top>window.innerHeight}(l)&&l.scrollIntoView();var v=window.setInterval(f,100),c=function(){try{l.parentNode.removeChild(l)}catch(e){}window.removeEventListener("click",c),window.removeEventListener("keydown",c),window.clearInterval(v)};window.addEventListener("click",c),window.addEventListener("keydown",c),t.push(c)}};return{initialize:t=>{null===e&&(e={filesUploadUrl:t[0]})},submit:(n,r,a,i)=>{for(var l={},u=0;u<t.length;u++)t[u]();t=[];for(var d=async()=>{await a("submitend"),await i()},s=async()=>{await a("submiterror"),await d()},f=function(e){var t=n.querySelector('[data-form-element-type="submit-button"]');null!==t?o(t,e):alert(e)},v=function(){var e={};e.serverData=r.serverData,e.values=JSON.stringify(l),clientPackages.get("serverRequests").then((function(t){t.send("ivopetkov-form",e).then(async e=>{try{var t=JSON.parse(e)}catch(e){t={}}if(void 0!==t.status)if("0"===t.status){if(await s(),void 0!==t.error.element&&t.error.element.length>0){var r=n.querySelector('[name="'+t.error.element+'"]');null!==r&&r.focus()}void 0!==t.error.message&&t.error.message.length>0&&(void 0!==t.error.element&&t.error.element.length>0&&null!==r?o(r,t.error.message):f(t.error.message))}else"1"===t.status&&await(async e=>{await a("submitsuccess",{result:e}),await d()})(t.result);else await s()}).catch(async()=>{await s(),f(r.errorMessage)})}))},c=function(t,n,r,o,a){var i=new XMLHttpRequest;i.addEventListener("load",(function(){200===i.status&&i.responseText.indexOf('"filename":')>0?n(JSON.parse(i.responseText)):o()})),i.addEventListener("error",(function(){o()})),i.addEventListener("abort",(function(){r()})),i.addEventListener("timeout",(function(){o()})),i.upload.addEventListener("loadstart",(function(){a(0)})),i.upload.addEventListener("loadend",(function(){a(100)})),i.upload.addEventListener("progress",(function(e){var t=void 0!==e.lengthComputable&&e.lengthComputable?Math.round(e.loaded/e.total*100):0;a(t)}));var l=new FormData;l.append("file",t),i.open("POST",e.filesUploadUrl,!0),i.send(l)},p={},m=!1,g=function(){for(var e in p)if(p[e]>0)return;v()},w=n.querySelectorAll("input, select, textarea"),h=w.length,y=0;y<h;y++){var b=w[y];if(b.name.length>0){var k=b.name,E=b.getAttribute("type");if(null===E&&(E="text"),"file"===E)if(void 0!==b.getFormElementContainer)!function(e,t,n){var r=function(){l[n]={type:t,value:e.getValue()}};e.hasPendingUploads()&&(p[n]=1,e.upload((function(e,t,n,r,o){c(e,(function(e){t(e)}),n,r,o)}),(function(){p[n]=0,r(),g()}),(function(){}),(function(){s()}),(function(e){})),m=!0),r()}(b.getFormElementContainer(),E,k);else void 0!==b.files&&b.files.length>0?function(e,t){var n=t.length;p[e]=n;var r=function(n){void 0!==t[n]&&c(t[n],(function(t){r(n+1),p[e]--,void 0===l[e]&&(l[e]={type:"file",value:[]}),l[e].value.push(t),0===p[e]&&(l[e].value=JSON.stringify(l[e].value)),g()}),(function(){}),(function(){s()}),(function(){}))};r(0),m=!0}(k,b.files):l[k]={type:E,value:""};else if(void 0!==b.getFormElementContainer){null!==(C=b.getFormElementContainer().getValue())&&(l[k]={type:E,value:C})}else{var C=b.value;"checkbox"===E||"radio"===E?b.checked&&(l[k]={type:E,value:C}):l[k]={type:E,value:C}}}}m||v()}}})();