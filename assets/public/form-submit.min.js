/*
 * Form addon for Bear Framework
 * https://github.com/ivopetkov/form-bearframework-addon
 * Copyright (c) Ivo Petkov
 * Free to use under the MIT license.
 */
var ivoPetkov=ivoPetkov||{};ivoPetkov.bearFrameworkAddons=ivoPetkov.bearFrameworkAddons||{},ivoPetkov.bearFrameworkAddons.formSubmit=ivoPetkov.bearFrameworkAddons.formSubmit||(()=>{var e=null,t=function(e,t){for(var n=0;n<1e3;n++){var a=(r=void 0,o=void 0,i=void 0,r=e.getBoundingClientRect(),o=Math.round(r.left),i=Math.round(r.top),[o+=window.pageXOffset,i+=window.pageYOffset]);if(0!==a[0]||0!==a[1])break;e=e.parentNode}var r,o,i;null!==e&&void 0!==e.tagName&&clientPackages.get("form").then((function(n){n.showTooltip(e,t)}))};return{initialize:t=>{null===e&&(e={filesUploadUrl:t[0]})},submit:(n,a,r,o)=>{for(var i={},l=async()=>{await r("submitend"),await o()},u=async(e,t)=>{void 0===e&&(e=""),void 0===t&&(t="");var n=await r("submiterror",{errorMessage:e,errorElement:t},!0);return await l(),n},s=function(e){var a=n.querySelector('[data-form-element-type="submit-button"]');null!==a?t(a,e):alert(e)},v=function(){var e={};e.serverData=a.serverData,e.values=JSON.stringify(i),clientPackages.get("serverRequests").then((function(o){o.send("ivopetkov-form",e).then(async e=>{try{var o=JSON.parse(e)}catch(e){o={}}if(void 0!==o.status)if("0"===o.status){var i=void 0!==o.error.element&&o.error.element.length>0?o.error.element:null,v=void 0!==o.error.message&&o.error.message.length>0?o.error.message:null;if(await u(v,i)){if(null!==i){var d=n.querySelector('[name="'+i+'"]');null!==d&&d.focus()}null!==v&&(null!==i&&null!==d?t(d,v):s(v))}}else"1"===o.status&&await(async e=>{await r("submitsuccess",{result:e}),await l()})(o.result);else await u(a.errorMessage)}).catch(async()=>{await u(a.errorMessage)&&s(a.errorMessage)})}))},d=function(t,n,a,r,o){var i=new XMLHttpRequest;i.addEventListener("load",(function(){200===i.status&&i.responseText.indexOf('"filename":')>0?n(JSON.parse(i.responseText)):r()})),i.addEventListener("error",(function(){r()})),i.addEventListener("abort",(function(){a()})),i.addEventListener("timeout",(function(){r()})),i.upload.addEventListener("loadstart",(function(){o(0)})),i.upload.addEventListener("loadend",(function(){o(100)})),i.upload.addEventListener("progress",(function(e){var t=void 0!==e.lengthComputable&&e.lengthComputable?Math.round(e.loaded/e.total*100):0;o(t)}));var l=new FormData;l.append("file",t),i.open("POST",e.filesUploadUrl,!0),i.send(l)},f={},c=!1,m=function(){for(var e in f)if(f[e]>0)return;v()},g=n.querySelectorAll("input, select, textarea"),p=g.length,h=0;h<p;h++){var w=g[h];if(w.name.length>0){var y=w.name,b=w.getAttribute("type");if(null===b&&(b="text"),"file"===b)if(void 0!==w.getFormElementContainer)!function(e,t,n){var a=function(){i[n]={type:t,value:e.getValue()}};e.hasPendingUploads()&&(f[n]=1,e.upload((function(e,t,n,a,r){d(e,(function(e){t(e)}),n,a,r)}),(function(){f[n]=0,a(),m()}),(function(){}),(function(){u()}),(function(e){})),c=!0),a()}(w.getFormElementContainer(),b,y);else void 0!==w.files&&w.files.length>0?function(e,t){var n=t.length;f[e]=n;var a=function(n){void 0!==t[n]&&d(t[n],(function(t){a(n+1),f[e]--,void 0===i[e]&&(i[e]={type:"file",value:[]}),i[e].value.push(t),0===f[e]&&(i[e].value=JSON.stringify(i[e].value)),m()}),(function(){}),(function(){u()}),(function(){}))};a(0),c=!0}(y,w.files):i[y]={type:b,value:""};else if(void 0!==w.getFormElementContainer){null!==(k=w.getFormElementContainer().getValue())&&(i[y]={type:b,value:k})}else{var k=w.value;"checkbox"===b||"radio"===b?w.checked&&(i[y]={type:b,value:k}):i[y]={type:b,value:k}}}}c||v()}}})();