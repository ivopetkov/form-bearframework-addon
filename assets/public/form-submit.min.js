/*
 * Form addon for Bear Framework
 * https://github.com/ivopetkov/form-bearframework-addon
 * Copyright (c) Ivo Petkov
 * Free to use under the MIT license.
 */
var ivoPetkov=ivoPetkov||{};ivoPetkov.bearFrameworkAddons=ivoPetkov.bearFrameworkAddons||{},ivoPetkov.bearFrameworkAddons.formSubmit=ivoPetkov.bearFrameworkAddons.formSubmit||(()=>{var e=null;return{initialize:t=>{null===e&&(e={filesUploadUrl:t[0]})},submit:(t,n,o,a,r,i)=>{for(var l={},u=function(){var e={};e.serverData=n.serverData,e.values=JSON.stringify(l),clientPackages.get("serverRequests").then((function(n){n.send("ivopetkov-form",e).then(async e=>{try{var n=JSON.parse(e)}catch(e){n={}}if(void 0!==n.status)if("0"===n.status){var l=void 0!==n.error.element&&n.error.element.length>0?n.error.element:null,u=void 0!==n.error.message&&n.error.message.length>0?n.error.message:null;if(await i(u,l,!1)){if(null!==l){var v=t.querySelector('[name="'+l+'"]');null!==v&&v.focus()}null!==u&&(null!==l&&null!==v?a(v,u):o(u))}}else"1"===n.status&&await r(n.result);else await i(void 0,void 0,!0)}).catch(async()=>{await i(void 0,void 0,!0)})})).catch(async()=>{await i(void 0,void 0,!0)})},v=function(t,n,o,a,r){var i=new XMLHttpRequest;i.addEventListener("load",(function(){200===i.status&&i.responseText.indexOf('"filename":')>0?n(JSON.parse(i.responseText)):a()})),i.addEventListener("error",(function(){a()})),i.addEventListener("abort",(function(){o()})),i.addEventListener("timeout",(function(){a()})),i.upload.addEventListener("loadstart",(function(){r(0)})),i.upload.addEventListener("loadend",(function(){r(100)})),i.upload.addEventListener("progress",(function(e){var t=void 0!==e.lengthComputable&&e.lengthComputable?Math.round(e.loaded/e.total*100):0;r(t)}));var l=new FormData;l.append("file",t),i.open("POST",e.filesUploadUrl,!0),i.send(l)},s={},d=!1,f=function(){for(var e in s)if(s[e]>0)return;u()},c=t.querySelectorAll("input, select, textarea"),m=c.length,p=0;p<m;p++){var g=c[p];if(g.name.length>0){var h=g.name,y=g.getAttribute("type");if(null===y&&(y="text"),"file"===y)if(void 0!==g.getFormElementContainer)!function(e,t,n){var o=function(){l[n]={type:t,value:e.getValue()}};e.hasPendingUploads()&&(s[n]=1,e.upload((function(e,t,n,o,a){v(e,(function(e){t(e)}),n,o,a)}),(function(){s[n]=0,o(),f()}),(function(e){}),function(e){return function(t){i(t,e),a(e,t)}}(g),(function(e){})),d=!0),o()}(g.getFormElementContainer(),y,h);else void 0!==g.files&&g.files.length>0?function(e,t){var n=t.length;s[e]=n;var o=function(n){void 0!==t[n]&&v(t[n],(function(t){o(n+1),s[e]--,void 0===l[e]&&(l[e]={type:"file",value:[]}),l[e].value.push(t),0===s[e]&&(l[e].value=JSON.stringify(l[e].value)),f()}),(function(){}),(function(){i()}),(function(){}))};o(0),d=!0}(h,g.files):l[h]={type:y,value:""};else if(void 0!==g.getFormElementContainer){null!==(k=g.getFormElementContainer().getValue())&&(l[h]={type:y,value:k})}else{var k=g.value;"checkbox"===y||"radio"===y?g.checked&&(l[h]={type:y,value:k}):l[h]={type:y,value:k}}}}d||u()}}})();