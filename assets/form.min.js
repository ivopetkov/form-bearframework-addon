/*
 * Form addon for Bear Framework
 * https://github.com/ivopetkov/form-bearframework-addon
 * Copyright (c) 2016-2017 Ivo Petkov
 * Free to use under the MIT license.
 */

var ivoPetkov=ivoPetkov||{};ivoPetkov.bearFrameworkAddons=ivoPetkov.bearFrameworkAddons||{};
ivoPetkov.bearFrameworkAddons.form=function(){var k=[],u=function(a){var e=document.querySelector('form[data-form-id="'+a+'"]');if(e){var c=k[a].data;if("undefined"!==typeof c&&1!==k[a].status){var b=document.createEvent("Event");b.initEvent("beforesubmit",!1,!0);if(e.dispatchEvent(b)){k[a].status=1;var d={},b=document.createEvent("Event");b.initEvent("requestsent",!1,!1);e.dispatchEvent(b);for(var g=function(){k[a].status=0;var d=document.createEvent("Event");d.initEvent("responsereceived",!1,!1);
e.dispatchEvent(d)},l=function(){var b={};b.serverData=c.serverData;b.values=JSON.stringify(d);ivoPetkov.bearFrameworkAddons.serverRequests.send("ivopetkov-form",b,function(d){g();try{var b=JSON.parse(d)}catch(x){b={}}if("undefined"!==typeof b.status)if("0"===b.status){if("undefined"!==typeof b.error.element&&0<b.error.element.length){var c=e.querySelector('[name="'+b.error.element+'"]');null!==c&&c.focus()}"undefined"!==typeof b.error.message&&0<b.error.message.length&&("undefined"!==typeof b.error.element&&
0<b.error.element.length&&null!==c?p(a,c,b.error.message):p(a,e,b.error.message))}else"1"===b.status&&(d=document.createEvent("Event"),d.initEvent("submitdone",!1,!1),d.result=b.result,e.dispatchEvent(d))},function(){g();p(a,e,"Error occurred. Please, try again later.")})},f={},t=!1,b=e.querySelectorAll("input, select, textarea"),m=b.length,q=0;q<m;q++){var h=b[q];if(0<h.name.length){var r=h.name,n=h.getAttribute("type");null===n&&(n="text");"file"===n?"undefined"!==typeof h.files&&0<h.files.length?
function(b){f[b]=null;var a=new XMLHttpRequest;a.addEventListener("load",function(){if(200===a.status&&0<a.responseText.indexOf('"filename":'))a:{var e=a.responseText;f[b]=1;d[b]={type:"file",value:e};for(var c in f)if(null===f[c])break a;l()}else g()});a.addEventListener("error",function(){g()});a.addEventListener("abort",function(){g()});a.addEventListener("timeout",function(){g()});for(var e=new FormData,m=0;m<h.files.length;m++)e.append("file"+m,h.files[m]);a.open("POST",c.filesUploadUrl,!0);
a.send(e);t=!0}(r):d[r]={type:n,value:""}:d[r]={type:n,value:h.value}}}t||l()}}}},v=function(a){a=a.getBoundingClientRect();return[a.width,a.height]},w=function(a){for(;a.parentNode&&"undefined"!==typeof a.parentNode.tagName;){var e=window.getComputedStyle(a,null);if(null===e)break;if("fixed"===e.position)return!0;a=a.parentNode}return!1},p=function(a,e,c){if("undefined"!==typeof k[a]){var b=k[a].data;if("undefined"!==typeof b){var d=document.createElement("a");d.className=b.errorTooltipData.className;
d.innerText=c;d.style.left="-1000px";d.style.top="-1000px";var g=w(e);g&&(d.style.position="fixed");document.body.appendChild(d);a=function(){var a=e.getBoundingClientRect();var c=Math.round(a.left);a=Math.round(a.top);c+=window.pageXOffset;a+=window.pageYOffset;c=[c,a];var f=v(e),a=v(d),f=c[0]+(f[0]-a[0])/2;5>f&&(f=5);c=c[1]-a[1]-2;g&&(f-=window.pageXOffset,c-=window.pageYOffset);d.style.left=f+"px";d.style.top="calc("+c+"px - "+b.errorTooltipData.arrowSize+")"};a();var l=window.setInterval(a,100),
f=function(){d.parentNode.removeChild(d);window.removeEventListener("click",f);window.clearInterval(l)};window.addEventListener("click",f);return d}}return null};return{initialize:function(a,e){k[a]={data:e,status:0};var c=document.querySelector('form[data-form-id="'+a+'"]');if(c){c.submit=function(){u(a)};var b=c.getAttribute("onbeforesubmit");null!==b&&c.addEventListener("beforesubmit",function(a){(new Function("return function(event){"+b+"}"))().bind(this)(a)});var d=c.getAttribute("onsubmitdone");
null!==d&&c.addEventListener("submitdone",function(a){(new Function("return function(event){"+d+"}"))().bind(this)(a)});var g=c.getAttribute("onrequestsent");null!==g&&c.addEventListener("requestsent",function(a){(new Function("return function(event){"+g+"}"))().bind(this)(a)});var l=c.getAttribute("onresponsereceived");null!==l&&c.addEventListener("responsereceived",function(a){(new Function("return function(event){"+l+"}"))().bind(this)(a)})}},submit:u}}();