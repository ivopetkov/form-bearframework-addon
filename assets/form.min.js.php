<?php

/*
 * Form addon for Bear Framework
 * https://github.com/ivopetkov/form-bearframework-addon
 * Copyright (c) Ivo Petkov
 * Free to use under the MIT license.
 */

return <<<'EOT'
var ivoPetkov=ivoPetkov||{};ivoPetkov.bearFrameworkAddons=ivoPetkov.bearFrameworkAddons||{},ivoPetkov.bearFrameworkAddons.form=ivoPetkov.bearFrameworkAddons.form||function(){var t=[],e=function(e){return void 0!==t[e]?document.querySelector('form[data-form-id="'+e+'"]'):null},r=async r=>{var n=e(r);if(null!==n){var a=t[r];if(1===a.status)return;var o=async(t,e)=>{var r=function(t){if("function"==typeof Event)return new Event(t);var e=document.createEvent("Event");return e.initEvent(t,!1,!1),e}(t);if(void 0!==e)for(var i in e)r[i]=e[i];var a=!1;"true"===n.getAttribute("disabled")&&(n.removeAttribute("disabled"),a=!0),r.promisesToWait=[];var o=n.dispatchEvent(r);return r.promisesToWait.length>0&&await Promise.allSettled(r.promisesToWait),a&&n.setAttribute("disabled","true"),o};if(!await o("beforesubmit"))return;a.status=1,i(r,!0),await o("submitstart"),clientPackages.get("-form-submit").then((function(t){t.submit(n,a,o,()=>{a.status=0,i(r,!1)})}))}},i=function(t,r){var i=e(t);if(null!==i){r?i.setAttribute("disabled","true"):i.removeAttribute("disabled");for(var n=i.querySelectorAll("input, select, textarea"),a=n.length,o=0;o<a;o++){var u=n[o];r?(u.setAttribute("disabled","true"),u.ipfrmds=1):void 0!==u.ipfrmds&&(u.removeAttribute("disabled"),delete u.ipfrmds)}}};return{initialize:function(i){var n=i[0];t[n]={serverData:i[1],errorMessage:i[2],status:0};var a=i[3],o=e(n);if(null!==o){o.submit=function(){r(n)};var u=function(t){var e=o.getAttribute("on"+t);null!==e&&o.addEventListener(t,(function(t){new Function("return function(event){"+e+"}")().bind(this)(t)}))};u("beforesubmit"),u("submitstart"),u("submitend"),u("submitsuccess"),u("submiterror");for(var s=function(t){void 0===t&&(t=null);for(var e=o.querySelectorAll("[data-form-element-type]"),r=[],i=0;i<e.length;i++){var n=e[i];(null===t||null!==n.querySelector('[name="'+t+'"]'))&&r.push(n)}return r},v=function(t){if("AND"===t[0]||"OR"===t[0]){for(var e="AND"===t[0],r=!1,i=1;i<t.length;i++)if(v(t[i])){if(!e){r=!0;break}var r=!0}else if(e)return!1;return r}var n=t[0],a=t[1];if("value"===a){var o=t[2],u=function(t){var e=s(t);if(e.length>0){if("radio"!==e[0].getAttribute("data-form-element-type"))return e[0].getValue();for(var r=0;r<e.length;r++)if(e[r].isChecked())return e[r].getValue()}return null}(n);if("string"!=typeof o){if(-1!==o.indexOf(u))return!0}else if(u===o)return!0}else if("checked"===a){var f=s(n);if(f.length>0&&"checkbox"===f[0].getAttribute("data-form-element-type"))return f[0].isChecked()}return!1},f=function(t){var e=[];if("AND"===t[0]||"OR"===t[0]){for(var r=1;r<t.length;r++)e=e.concat(f(t[r]));return e}return e.push(t[0]),e},l=[],d=0;d<a.length;d++){var b=a[d][2];l=l.concat(f(b))}var c=function(){for(var t=0;t<a.length;t++){var e=a[t][1],r=a[t][2],i=s(e);if("visible"===a[t][0])for(var n=v(r),o=0;o<i.length;o++)void 0!==i[o].setVisibility&&i[o].setVisibility(n)}},m=[];for(d=0;d<l.length;d++){var g=l[d];if(void 0===m[g]){m[g]=1;for(var h=s(g),A=0;A<h.length;A++)h[A].addEventListener("change",c)}}var k=function(){r(n);for(var t=s(),e=0;e<t.length;e++){var i=t[e];if("submit-button"===i.getAttribute("data-form-element-type")){i.scrollIntoView(!1);break}}},p=s();for(d=0;d<p.length;d++){var y=p[d];"textbox"===y.getAttribute("data-form-element-type")&&y.addEventListener("keydown",(function(t){13===t.keyCode&&k()}))}}},submit:r}}();
EOT;
